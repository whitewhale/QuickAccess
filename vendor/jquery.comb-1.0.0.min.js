;(function($){"use strict";var defaults,internalData,methods;defaults={matchWeights:{partialWord:1,partialFirstWord:2,partialWordStart:1,partialFirstWordStart:2,wholeWord:5,wholeFirstWord:5,partialWhole:2,partialWholeStart:2,whole:10},minCharacters:3,minWordCharacters:2,scoreThreshold:1,propertyWeights:{},queryMode:"boolean",stemming:false,customStemming:null,alternates:false,customAlternates:null,includeFullQuery:true,preformat:function(keyword){return keyword.replace(/[^\w\d\-\+\s&Õ'Ô]/ig,"");},limit:false,enableTooManyResults:false,delay:null,sortByScore:true,groupByCategory:false,onNoQuery:function(){},onNotEnoughCharacters:function(){},onNoResultsFound:function(){},onError:function(){},onResultsFound:function(results){},onComplete:function(){},onTooManyResultsFound:function(){},loadFrom:null,formatRemoteData:function(data){return data;},forceReloadOnEachKeypress:false,haystack:{},excludeProperties:[],remoteDataType:"json",ajaxTimeout:5000,filteredKeyCodes:[],filter:function(){},debug:false};internalData={dataPrepared:false,isCategorizedHaystack:false,queryStartTime:null,delayTimeout:null,internalHaystack:[]};methods={init:function(options){var settings;options=options||{};settings=$.extend({},defaults,options,internalData);this.data("comb",settings).bind("keypress.comb",function(){var a,self=$(this);if(settings.filteredKeyCodes.length){for(a in settings.filteredKeyCodes){if(settings.filteredKeyCodes[a]===e.keyCode){settings.filter.apply(self,[e.keyCode]);return this;}}}
try{methods.loadData.apply(self,[settings.forceReloadOnEachKeypress]);}catch(error){if(settings.debug){console.debug(error);}}});return this.each(function(){var self=$(this),settings=self.data("comb");self.bind("keyup.comb",function(e){var query;try{settings.queryStartTime=$.now();methods.testRelevantKeystroke.apply(self,[e.keyCode]);query=settings.preformat.apply(self,[$.trim($(this).val())]);if(settings.forceReloadOnEachKeypress&&query.length<settings.minCharacters){throw("");}
methods.lookUp.apply(self,[query]);}catch(error){if(error&&settings.debug){console.debug("Error: "+error);}
return false;}});});},lookUp:function(query){var params,data,self=$(this),settings=self.data("comb");methods.testValidQuery.apply(self,[query]);params=methods.parseSearchParameters.apply(self,[query]);data=methods.removeDisallowedMatches.apply(self,[params,settings.internalHaystack]);if(settings.delay){clearTimeout(settings.delayTimeout);settings.delayTimeout=setTimeout(function(){methods.searchOverData.apply(self,[params,data,query]);},settings.delay);}else{if(settings.forceReloadOnEachKeypress&&settings.loadFrom&&settings.debug){console.log("Pro Tip: Set the 'delay' setting for better performance.");}
methods.searchOverData.apply(self,[params,data,query]);}},loadData:function(forceReload){var cacheName,loadFromURL,self=$(this),settings=self.data("comb");if(settings.dataPrepared&&!forceReload){return;}
settings.dataPrepared=true;if(settings.loadFrom){loadFromURL=($.isFunction(settings.loadFrom))?settings.loadFrom.apply(self):settings.loadFrom;cacheName="comb-cache_"+loadFromURL;if($("body").data(cacheName)===false){return this;}else if($("body").data(cacheName)){settings.internalHaystack=$("body").data(cacheName);}else{$("body").data(cacheName,false);$.ajax({url:loadFromURL,dataType:settings.remoteDataType,timeout:settings.ajaxTimeout,error:function(jqXHR,status,error){throw("Ajax error: "+error);},success:function(data,status,jqXHR){data=settings.formatRemoteData.apply(self,[data]);methods.prepareData.apply(self,[data,function(){$("body").data(cacheName,data);self.keyup();}]);}});return this;}}else{methods.prepareData.apply(self,[settings.haystack]);}},prepareData:function(data,callback){var a,b,record,self=$(this),output=[];callback=callback||function(){};if($.isArray(data)){for(a=0;a<data.length;a++){record=data[a];record._category="data";output.push(record);}}else{self.data("comb").isCategorizedHaystack=true;for(a in data){if(data.hasOwnProperty(a)){if(!$.isArray(data[a])){continue;}
for(b=0;b<data[a].length;b++){record=data[a][b];record._category=a;output.push(record);}}}}
output=methods.removeDisallowedProperties.apply(self,[output]);self.data("comb").internalHaystack=output;callback.apply(self);},searchOverData:function(params,data,rawQuery){var obj,found,regex,property,words,strength,result,score,categorizedOutput,cleaned,matchWeight,clonedData,a,b,c,d,e,f,g,h,i,j,settings=this.data("comb"),output=[],info={},outputLength=0;if(!data.length){if(params.required){settings.onComplete.apply(this);settings.onNoResultsFound.apply(this,[info]);settings.onError.apply(this);throw("No results found.");}else{settings.onComplete.apply(self);settings.onError.apply(self);throw("Empty haystack.");}
return;}
info={totalResults:0,rawQuery:rawQuery,parsedQuery:params,queryTime:0.0};for(a in data){if(data.hasOwnProperty(a)){obj=data[a].pruned;found={partialWord:0,partialFirstWord:0,partialWordStart:0,partialFirstWordStart:0,wholeWord:0,wholeFirstWord:0,partialWhole:0,partialWholeStart:0,whole:0};for(b=0;b<params.chunks.length;b++){regex={whole:new RegExp("^"+params.chunks[b]+"$","ig"),partial:new RegExp(params.chunks[b],"ig"),partialFromStart:new RegExp("^"+params.chunks[b],"ig")};for(c in obj){if(obj.hasOwnProperty(c)){property=($.isArray(obj[c]))?obj[c].join(" "):obj[c];if(typeof property!=="string"){continue;}
words=property.split(/\s+/ig);strength=settings.propertyWeights[c]||1;i=0;result=property.match(regex.whole);if(result){found.whole+=result.length;}
result=property.match(regex.partial);if(result){found.partialWhole+=result.length;}
result=property.match(regex.partialFromStart);if(result){found.partialWholeStart+=result.length;}
for(d=0;d<words.length;d++){result=words[d].match(regex.whole);if(result){found.wholeWord+=strength*result.length;if(i===0){found.wholeFirstWord+=strength*result.length;}}
result=words[d].match(regex.partial);if(result){found.partialWord+=strength*result.length;if(i===0){found.partialFirstWord+=strength*result.length;}}
result=words[d].match(regex.partialFromStart);if(result){found.partialWordStart+=strength*result.length;if(i===0){found.partialFirstWordStart+=strength*result.length;}}
i++;}}}}
score=0;for(e in defaults.matchWeights){if(defaults.matchWeights.hasOwnProperty(e)){matchWeight=(typeof settings.matchWeights[e]!=="undefined")?settings.matchWeights[e]:defaults.matchWeights[e];score+=found[e]*matchWeight;}}
data[a].score=score;}}
clonedData=methods.cloneArray.apply(null,[data]);if(settings.sortByScore){clonedData.sort(function(a,b){if(a.score>b.score){return-1;}else if(a.score<b.score){return 1;}else{return 0;}});}
for(f in clonedData){if(clonedData[f].score>=settings.scoreThreshold){cleaned=$.extend({},clonedData[f]);delete cleaned.pruned;output.push(cleaned);}}
info.totalResults=output.length;if(settings.groupByCategory&&settings.isCategorizedHaystack){categorizedOutput={};for(g=0;g<output.length;g++){if(!categorizedOutput[output[g].category]){categorizedOutput[output[g].category]=[];outputLength++;}
if(settings.limit&&categorizedOutput[output[g].category].length<settings.limit){categorizedOutput[output[g].category].push(output[g]);}}
output=categorizedOutput;}else if(settings.limit){if(settings.enableTooManyResults&&output.length>settings.limit){settings.onComplete.apply(this);settings.onTooManyResultsFound.apply(this,[info]);settings.onError.apply(this);throw("Too many results found.");return;}
output=output.slice(0,settings.limit);outputLength=output.length;}else{outputLength=output.length;}
info.queryTime=methods.markEndQueryTime.apply(this);if(outputLength===0){settings.onComplete.apply(this);settings.onNoResultsFound.apply(this,[info]);settings.onError.apply(this);throw("No results found.");return;}
settings.onComplete.apply(this);settings.onResultsFound.apply(this,[output,info]);},removeDisallowedProperties:function(data){var a,b,output=[],settings=this.data("comb");for(a=0;a<data.length;a++){var localData,category=data[a]._category;delete data[a]._category;localData=$.extend(true,{},data[a]);for(b=0;b<settings.excludeProperties.length;b++){delete localData[settings.excludeProperties[b]];}
output.push({data:$.extend(true,{},data[a]),pruned:localData,score:0,category:category});}
return output;},removeDisallowedMatches:function(params,data){var a,b,record,settings=this.data("comb"),newData=[],disallowed=new RegExp(params.disallowed.join("|"),"i"),required=new RegExp("(?=.*"+params.required.join(")(?=.*")+")","i");if(settings.queryMode!=="boolean"||(params.disallowed.length===0&&params.required.length===0)){return data;}
for(a=0;a<data.length;a++){try{record="";for(b in data[a].pruned){if(data[a].pruned.hasOwnProperty(b)){record+=" "+data[a].pruned[b];}}
if(params.disallowed.length&&disallowed.test(record)===true){throw("");}
if(params.required.length&&!required.test(record)){throw("");}}catch(err){continue;}
newData.push(data[a]);}
return newData;},standardizeArray:function(array){var a,i=0,output=[],sorted=array.sort();for(a=0;a<sorted.length;a++){if(typeof sorted[a]!=="string"){continue;}
sorted[a]=sorted[a].toLowerCase();}
for(i;i<=sorted.length-1;i++){if(sorted[i+1]!==sorted[i]){output.push(sorted[i]);}}
return output;},cloneArray:function(array){var i=0,newArray=[],arrayLength=array.length;for(i;i<arrayLength;i++){newArray.push($.extend(true,{},array[i]));}
return newArray;},testRelevantKeystroke:function(keyCode){switch(keyCode){case 13:case 16:case 17:case 18:case 91:case 20:case 9:case 37:case 38:case 39:case 40:case 27:throw("");default:}},testValidQuery:function(query){var settings=this.data("comb");if(query.length===0){settings.onComplete.apply(this);settings.onNoQuery.apply(this);settings.onError.apply(this);throw("No query.");}else if(query.length<this.data("comb").minCharacters){settings.onComplete.apply(this);settings.onNotEnoughCharacters.apply(this);settings.onError.apply(this);throw("Not enough characters.");}},parseSearchParameters:function(query){var words,word,stemmed,alternate,parts,x,self=$(this),settings=self.data("comb");if(settings.queryMode==="words"){parts={chunks:[],required:[],disallowed:[]};if(settings.stemming){words=query.split(/\s+/ig);for(x=0;x<words.length;x++){word=words[x].toLowerCase();stemmed=methods.stemWord.apply(self,[word]);alternate=methods.getAlternateWords.apply(self,[word]);if(stemmed){parts.chunks.push(stemmed);}
if(alternate){parts.chunks=$.merge(parts.chunks,alternate);}
parts.chunks.push(word);}}else{parts.chunks=query.split(/\s+/ig);}
if(settings.includeFullQuery){parts.chunks.push(query);}}else if(settings.queryMode==="boolean"){words=query.split(/\s+/ig);parts={chunks:[],required:[],disallowed:[]};for(x=0;x<words.length;x++){word=words[x].toLowerCase();stemmed=methods.stemWord.apply(self,[word]);alternate=methods.getAlternateWords.apply(self,[word]);if(word.indexOf("-")===0&&word.length>=settings.minWordCharacters+1){parts.disallowed.push(word.substring(1));}else if(word.indexOf("+")===0&&word.length>=settings.minWordCharacters+1){parts.required.push(word.substring(1));}else if(word.length>=settings.minWordCharacters){if(stemmed){parts.chunks.push(stemmed);}
if(alternate){parts.chunks=$.merge(parts.chunks,alternate);}
parts.chunks.push(word);}}
if(parts.required.length>0&&parts.chunks.length==0){parts.chunks=parts.required;}
if(settings.includeFullQuery){parts.chunks.push(query);}}else{words=query.toLowerCase();stemmed=methods.stemWord.apply(self,[words]);alternate=methods.getAlternateWords.apply(self,[words]);if(stemmed){words.push(stemmed);}
if(alternate){parts.chunks=$.merge(parts.chunks,alternate);}
parts={chunks:[words],required:[],disallowed:[]};}
parts={chunks:methods.standardizeArray.apply(self,[parts.chunks]),required:methods.standardizeArray.apply(self,[parts.required]),disallowed:methods.standardizeArray.apply(self,[parts.disallowed])};return parts;},stemWord:function(word){var self=$(this),settings=self.data("comb");if(!settings.stemming){return false;}
if($.isFunction(settings.customStemming)){return settings.customStemming.apply(self,[word]);}
if(word.length>=4&&word.substring(word.length-1)==="s"&&word.substring(word.length-2)!=="ss"){return word.substring(0,word.length-1);}
return false;},getAlternateWords:function(word){var matches=[],self=$(this),settings=self.data("comb");if(!settings.alternates){return false;}
if($.isFunction(settings.customAlternates)){return settings.customAlternates.apply(self,[word]);}
switch(word){case"and":return["&"];case"&":return["and"];}
if(word.indexOf("Õ")!==-1){matches.push(word.replace(/Õ/g,"'"));matches.push(word.replace(/Õ/g,"Ô"));}else if(word.indexOf("'")!==-1){matches.push(word.replace(/'/g,"Õ"));matches.push(word.replace(/'/g,"Ô"));}else if(word.indexOf("Ô")!==-1){matches.push(word.replace(/Ô/g,"'"));matches.push(word.replace(/Ô/g,"Õ"));}
if(matches.length){return matches;}
return false;},markEndQueryTime:function(){var time,self=$(this),settings=self.data("comb");time=(($.now()-settings.queryStartTime)/1000).toFixed(3)+"s";if(settings.debug){console.debug("Query time: "+time);}
return time;}};$.fn.comb=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==="object"||$.isFunction(method)||!method){return methods.init.apply(this,arguments);}else{$.error("Method "+method+" does not exist for jQuery.comb.");}};})(jQuery);